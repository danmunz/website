# Website Specification

## 1. High-level overview
- **Framework:** The site is built with Eleventy (11ty). The main config file is `eleventy.config.js`, and content lives under `content/` with layouts in `_includes/layouts/`.【F:eleventy.config.js†L1-L193】【F:content/content.11tydata.js†L1-L3】【F:_includes/layouts/base.njk†L1-L106】
- **Output:** Builds to `_site/` with passthrough copies from `public/`, `css/`, and `og-images/`.【F:eleventy.config.js†L21-L52】
- **Site metadata:** Global metadata is defined in `_data/metadata.js` and used in templates for titles, descriptions, and links.【F:_data/metadata.js†L1-L9】【F:_includes/layouts/base.njk†L1-L45】

## 2. Information architecture (IA) & navigation
- **Primary navigation:** The header renders top-level navigation using `eleventy-navigation` across all collections, sourcing items from front matter in top-level content files (Home, Archive, About, Feed).【F:_includes/layouts/base.njk†L61-L75】【F:content/index.njk†L1-L4】【F:content/blog.njk†L1-L5】【F:content/about.md†L1-L4】【F:eleventy.config.js†L68-L109】
- **Home (`/`):** Summary intro plus latest 3 posts and a link to the archive. The list is rendered in-line on the homepage with post date, title, and description.【F:content/index.njk†L1-L33】
- **Archive (`/blog/`):** Lists categories (tags) and all posts. Tags are derived from post front matter, excluding `posts` and `post`.【F:content/blog.njk†L1-L31】
- **Tags & tag pages:**
  - `/tags/` lists all tags using `getKeys` + `filterTagList` from filters.【F:content/tags.njk†L1-L7】【F:_config/filters.js†L34-L40】
  - `/tags/<slug>/` pages are generated via pagination in `tag-pages.njk`, using the collection of each tag for the post list.【F:content/tag-pages.njk†L1-L22】
- **Posts:** All posts in `content/blog/` inherit the `layouts/post.njk` layout and are part of the `posts` collection via `blog.11tydata.js`.【F:content/blog/blog.11tydata.js†L1-L6】【F:_includes/layouts/post.njk†L1-L38】
- **404:** A custom 404 page is provided at `/404.html` to support static hosting platforms.【F:content/404.md†L1-L16】
- **Sitemap:** Generated at `/sitemap.xml` from all collections, using `htmlBaseUrl` for absolute URLs.【F:content/sitemap.xml.njk†L1-L12】
- **Feed:** Atom feed generated by `@11ty/eleventy-plugin-rss`, with a custom XSL stylesheet for a human-readable preview.【F:eleventy.config.js†L86-L121】【F:content/feed/pretty-atom-feed.xsl†L1-L89】

## 3. Design system & visual styling
### 3.1 Typography
- **Primary body font:** `Bricolage Grotesque` at `300` weight, used as the default body font and general UI copy.【F:css/index.css†L2-L9】
- **Headings font:** `Oswald` used for headers, navigation, and post titles.【F:css/index.css†L2-L9】【F:css/index.css†L217-L271】
- **Monospace:** `DM Mono` for inline code and code blocks.【F:css/index.css†L2-L9】【F:css/index.css†L119-L180】
- **Serif accent:** `IBM Plex Serif` used for blockquotes to provide a typographic contrast.【F:css/index.css†L2-L9】【F:css/index.css†L359-L396】
- **Fonts are loaded from Google Fonts** in the base layout for all pages.【F:_includes/layouts/base.njk†L32-L36】

### 3.2 Color palette (current theme)
Defined as CSS variables in `:root` and used across the UI:
- **Background:** `#fcfdfe` (page background).【F:css/index.css†L15-L16】
- **Primary text:** `#333` via `--color-gray-90`.【F:css/index.css†L11-L16】
- **Accent/link blue:** `#42a5f5` (links, accents).【F:css/index.css†L18-L20】
- **Hover/active blue:** `#1e88e5` (link hover and main heading).【F:css/index.css†L18-L20】【F:css/index.css†L239-L247】
- **Muted gray:** `#6c7b8a` for metadata and secondary text.【F:css/index.css†L9-L13】
- **Pill/background gray:** `#ebf5ff` for tags and soft backgrounds (tags, footnotes).【F:css/index.css†L9-L13】【F:css/index.css†L328-L347】【F:css/index.css†L406-L430】

### 3.3 Layout & spacing
- **Page width:** `body` max-width is `40em`, giving a readable, single-column layout with generous whitespace.【F:css/index.css†L46-L51】
- **Header layout:** Flex-based header with site title and nav aligned and wrapped as needed (responsive by default).【F:css/index.css†L210-L238】
- **Main content:** `main` has padding and larger font size for readability; footer uses a smaller font with top border.【F:css/index.css†L81-L96】

### 3.4 Responsive behavior
- **Overall layout:** A single-column layout with flexible header and nav; no explicit mobile-only breakpoints except for a footnotes padding change at `min-width: 1024px`. Most elements (images, video, iframe) are fluid to fit screen width.【F:css/index.css†L52-L78】【F:css/index.css†L418-L427】
- **Media behavior:** Images and embeds scale to `max-width: 100%`, with iframes using a 16:9 aspect ratio for responsive video embeds.【F:css/index.css†L58-L77】

### 3.5 Code blocks & syntax highlighting
- **Syntax highlighting:** Uses `@11ty/eleventy-plugin-syntaxhighlight` with a custom Prism theme (`css/prism-custom-theme.css`). The theme is included inline in the base layout.【F:eleventy.config.js†L66-L85】【F:css/prism-custom-theme.css†L1-L35】【F:_includes/layouts/base.njk†L41-L46】
- **Code styling:** Custom styles for inline code, Prism-highlighted blocks, and fallback pre blocks (with copy button support).【F:css/index.css†L119-L207】
- **Copy button:** Inline JS in the base layout adds a “Copy” button to each highlighted block and uses the Clipboard API to copy content.【F:_includes/layouts/base.njk†L92-L113】

### 3.6 Post list & metadata presentation
- **Post list styling:** Post lists use large heading typography for titles, and metadata is displayed as a date label plus description. A custom dot marker precedes dates.【F:css/index.css†L273-L327】【F:_includes/postslist.njk†L3-L11】
- **Post meta row:** Post pages show date + tags in a flexible row with tag pills for taxonomy browsing.【F:css/index.css†L328-L355】【F:_includes/layouts/post.njk†L11-L24】

### 3.7 Blockquotes, footnotes, and notes
- **Blockquotes:** Styled with serif font, soft background and blue left border, plus decorative quotation marks.【F:css/index.css†L359-L396】
- **Footnotes:** Generated by `eleventy-plugin-footnotes` and styled with a container background and inline footnote counters.【F:eleventy.config.js†L72-L83】【F:css/index.css†L406-L458】
- **Notes:** A `.note` class exists for inline callout blocks (yellow background and subtle box shadow).【F:css/index.css†L348-L358】

## 4. Content model, collections, and markdown usage
### 4.1 Content structure
- **Content root:** `content/` contains pages and posts. The entire folder uses `layouts/home.njk` by default, unless overridden by local data files or front matter.【F:content/content.11tydata.js†L1-L3】
- **Blog posts:** `content/blog/` is the canonical posts directory; `blog.11tydata.js` applies `posts` tag and `layouts/post.njk` layout for all posts.【F:content/blog/blog.11tydata.js†L1-L6】

### 4.2 Draft handling
- **Drafts workflow:** Drafts are managed by moving posts in and out of a `/drafts` folder (rather than toggling front matter). Only posts in `content/blog/` are included in the live collections by default, so drafts kept elsewhere will not publish.【F:content/blog/blog.11tydata.js†L1-L6】
- **Front matter validation:** The Zod schema currently validates the optional `draft` field, but the active workflow is folder-based rather than relying on the `draft` flag during builds.【F:_data/eleventyDataSchema.js†L1-L12】

### 4.3 Markdown rendering rules
- **Markdown engine:** `markdown-it` with `html: true`, `breaks: true`, and `linkify: true`. This means raw HTML is allowed, line breaks render as `<br>`, and URLs are auto-linked.【F:eleventy.config.js†L147-L153】
- **Footnotes in markdown:** The `eleventy-plugin-footnotes` plugin provides `{% footnoteref %}` and `{% footnotes %}` tags used in post and page templates (see `about.md` and post layout).【F:eleventy.config.js†L72-L83】【F:_includes/layouts/post.njk†L31-L40】【F:content/about.md†L15-L33】
- **Blockquotes:** Standard Markdown blockquotes render with custom styling in CSS (see design section).【F:css/index.css†L359-L396】
- **Code blocks:** Prism syntax highlighting is applied to fenced code blocks (and fallback styling for plain `<pre>` blocks).【F:eleventy.config.js†L66-L85】【F:css/index.css†L119-L207】

### 4.4 Images & embeds in content
- **Image optimization:** The Eleventy Image plugin transforms images with output formats `avif`, `webp`, and `auto`; `loading="lazy"` and `decoding="async"` are default attributes.【F:eleventy.config.js†L123-L145】
- **OG images:** For pages with `page.fileSlug`, OG images are expected at `/og-images/<slug>.png`; otherwise a default share image is used.【F:_includes/layouts/base.njk†L7-L29】
- **Embed handling:** Videos/iframes are responsive via CSS and a 16:9 aspect ratio.【F:css/index.css†L66-L77】

## 5. Templating system
### 5.1 Layouts
- **Base layout (`layouts/base.njk`):** Defines the global HTML structure, head tags, CSS/JS bundles, nav, skip link, and footer. It also injects analytics and copy-button JS.【F:_includes/layouts/base.njk†L1-L113】
- **Home layout (`layouts/home.njk`):** Wraps content and outputs footnotes after the main content region.【F:_includes/layouts/home.njk†L1-L6】
- **Post layout (`layouts/post.njk`):** Renders title, date, tags, main content, footnotes, and previous/next navigation between posts.【F:_includes/layouts/post.njk†L1-L45】
- **Post list component (`postslist.njk`):** Renders an ordered list with date/title/description and reverse chronological numbering.【F:_includes/postslist.njk†L1-L11】

### 5.2 Bundles and assets
- **CSS bundling:** Eleventy bundler collects inline `<style>` blocks into `dist/` and injects the bundle in the base layout.【F:eleventy.config.js†L33-L57】【F:_includes/layouts/base.njk†L41-L46】
- **JS bundling:** Similar bundling for `<script>` tags into `dist/`, referenced from the base layout at the end of `body`.【F:eleventy.config.js†L58-L65】【F:_includes/layouts/base.njk†L101-L104】
- **Passthrough copies:** `public/` (for static assets), `css/`, and `og-images/` are copied directly to output during build.【F:eleventy.config.js†L21-L52】

## 6. Automated OG image generation (blog post “art”)
- **Generator:** `scripts/generate-og-images.js` scans `content/blog/*.md`, extracts front matter via `front-matter`, renders HTML using the Nunjucks template, and captures a 1200×630 screenshot via Puppeteer. The output is stored in `og-images/` and then copied to `_site/og-images/` on build.【F:scripts/generate-og-images.js†L1-L55】【F:eleventy.config.js†L21-L52】
- **Template:** `_includes/og-image-template.html` defines the visual style for OG images (blue background, Oswald title, Bricolage Grotesque metadata).【F:_includes/og-image-template.html†L1-L58】
- **Build hook:** The `build` script in `package.json` runs the OG generator before `npx @11ty/eleventy`, ensuring OG images are refreshed with each build.【F:package.json†L6-L18】

## 7. Publishing workflow & deployment
- **Local development:** `npm run start` runs Eleventy in serve mode with live reload (`npx @11ty/eleventy --serve`).【F:package.json†L6-L18】
- **Production build:** `npm run build` generates OG images and runs Eleventy to produce `_site/`.【F:package.json†L6-L18】
- **Draft handling:** Drafts are stored outside `content/blog/` (for example, a top-level `/drafts` folder). Only posts in `content/blog/` are published by default, so moving files in/out of that folder is the publish toggle.【F:content/blog/blog.11tydata.js†L1-L6】
- **GitHub Actions deployment:** A push to `main` triggers the GitHub Actions workflow in `.github/workflows/deploy.yml`, which installs Node 20, runs `npm run build`, copies `CNAME` into `_site/`, and deploys via `peaceiris/actions-gh-pages` to GitHub Pages.【F:.github/workflows/deploy.yml†L1-L31】
- **Custom domain:** The `CNAME` file declares `danmu.nz`, and the workflow copies it into `_site/` for GitHub Pages custom domain setup. The site URL is also baked into metadata and the Eleventy global data file.【F:CNAME†L1-L1】【F:_data/metadata.js†L1-L9】【F:eleventy.config.js†L9-L11】【F:.github/workflows/deploy.yml†L23-L27】

## 8. Analytics, SEO, and social metadata
- **Open Graph/Twitter cards:** The base layout sets OG/Twitter metadata and uses post-specific OG images when `page.fileSlug` exists; otherwise it falls back to `/img/share-img.png`.【F:_includes/layouts/base.njk†L7-L29】
- **Google Analytics:** The base layout includes a GA4 tag (`G-PM95BS3TNB`).【F:_includes/layouts/base.njk†L67-L87】
- **Sitemap and feed:** A sitemap and Atom feed are generated at build time, supporting SEO and syndication.【F:content/sitemap.xml.njk†L1-L12】【F:eleventy.config.js†L86-L121】

## 9. Webmentions & social identity links
- **Webmentions:** The site integrates the `eleventy-plugin-webmentions` plugin and requires a `WEBMENTION_IO_TOKEN` environment variable for build-time fetching/processing.【F:eleventy.config.js†L86-L93】
- **Rel=me links:** `rel="me"` links in the base layout support identity verification across GitHub/LinkedIn/Bluesky profiles.【F:_includes/layouts/base.njk†L35-L40】

## 10. Useful operational notes for future maintainers
- **Where to add posts:** Create a Markdown file in `content/blog/` with front matter (`title`, `description`, `date`, `tags`). It will inherit the post layout and appear in collections automatically.【F:content/blog/blog.11tydata.js†L1-L6】【F:_includes/layouts/post.njk†L1-L24】
- **Draft posts:** Keep drafts outside `content/blog/` (for example in `/drafts`). Moving a file into `content/blog/` is how it gets published.【F:content/blog/blog.11tydata.js†L1-L6】
- **Tagging:** Tags are derived from the `tags` array in front matter; `posts` is required and filtered out from tag lists by the `filterTagList` filter.【F:content/blog/blog.11tydata.js†L1-L6】【F:_config/filters.js†L34-L40】
- **OG image generation:** Run `npm run generate-og-images` if you need to regenerate the social images without a full build. Output lives in `og-images/` and is committed to the repo (per passthrough copy and usage in templates).【F:package.json†L6-L18】【F:scripts/generate-og-images.js†L1-L55】【F:eleventy.config.js†L21-L52】
- **Static assets:** Add global images to `public/` (copied verbatim to the site root). Site-wide CSS lives in `css/index.css` and is inlined via the base layout.【F:eleventy.config.js†L21-L52】【F:_includes/layouts/base.njk†L41-L46】
- **Content embeds:** If embedding interactive content or scripts in Markdown, remember `markdown-it` allows raw HTML in content, so script tags are permitted (as seen in a sample post).【F:eleventy.config.js†L147-L153】【F:content/blog/ai-thinking-fast-and-slow.md†L33-L46】
